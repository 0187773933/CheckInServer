<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Admin - Check In User</title>
	<script src="/test/nacl.min.js"></script>
</head>
<body>
	<h1>Check In User :</h1>

	<label>Scan Barcode :</label>
	<input type="text" id="barcode" name="barcode" style="width: 300px;" ><br><br>

	<form id="user-checkin-form" action="/user/checkin" method="post">
		<fieldset>
			<legend>User Information</legend>

			<label for="barcode">Barcode :</label>
			<input type="text" id="barcode" name="barcode" ><br><br>

			<label for="username">Child's Name :</label>
			<input type="text" id="username" name="username" ><br><br>

			<label for="parents_first_name">Parent's First Name :</label>
			<input type="text" id="parents_first_name" name="parents_first_name" ><br><br>

			<label for="parents_last_name">Parent's Last Name :</label>
			<input type="text" id="parents_last_name" name="parents_last_name" ><br><br>

			<label for="phone_number">Phone Number :</label>
			<input type="tel" id="phone_number" name="phone_number"><br><br>

			<label for="email_address">Email Address :</label>
			<input type="email" id="email_address" name="email_address"><br><br>

			<label for="family_size">Family Size:</label>
			<input type="number" id="family_size" name="family_size" value="1" min="1"><br><br>
		</fieldset>

		<button type="submit">Check In</button>
	</form>

	<script type="text/javascript">
		const uuid_v4_regex = /^[0-9A-F]{8}-[0-9A-F]{4}-[4][0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i
		function is_uuid( str ) { return uuid_v4_regex.test( str ); }
		const barcode_regex = /^\d+$/;
		function is_barcode( str ) { return barcode_regex.test( str ); }
		function convert_bytes_to_hex_string( key_bytes ) {
			let key_string = Array.from( key_bytes ).map( byte => byte.toString( 16 ).padStart( 2 , '0' ) ).join( '' );
			return key_string;
		}
		function uint8_array_to_base64( uint8Array ) {
			return btoa( String.fromCharCode( ...uint8Array ) );
		}
		function base64_to_uint8_array( base64 ) {
			return new Uint8Array( atob( base64 ).split( "" ).map( char => char.charCodeAt( 0 ) ) );
		}
		function get_uuid_in_url() {
			const url = window.location.href;
			const uuidPattern = /[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;
			const match = url.match(uuidPattern);
			const uuid = match ? match[0] : false;
			return uuid;
		}
		function get_user( uuid ) {
			return new Promise( function( resolve , reject ) {
				try {
					var currentUrl = window.location.href;
					var url = currentUrl.replace( /\/checkin$/ , "/get/" + uuid );
					var xhr = new XMLHttpRequest();
					xhr.open( "GET" , url , false );
					xhr.setRequestHeader( "Content-Type" , "application/json" );
					xhr.onload = function () {
						if ( xhr.status === 200 ) {
							var response = JSON.parse( xhr.responseText );
							resolve( response );
							return;
						} else {
							console.error( "Error fetching blank user:" , xhr.statusText );
							resolve( false );
							return;
						}
					};
					xhr.onerror = function () {
						console.error( "GET request error" );
						resolve( false );
						return;
					};
					xhr.send();
				}
				catch( error ) { console.log( error ); resolve( false ); return; }
			});
		}
		function fuzzy_search_user( input_text ) {
			return new Promise( function( resolve , reject ) {
				try {
					var currentUrl = window.location.href;
					var url = currentUrl.replace( /\/checkin$/ , "/search/" +  encodeURIComponent( input_text ) );
					console.log( url );
					var xhr = new XMLHttpRequest();
					xhr.open( "GET" , url , false );
					xhr.setRequestHeader( "Content-Type" , "application/json" );
					xhr.onload = function () {
						if ( xhr.status === 200 ) {
							var response = JSON.parse( xhr.responseText );
							resolve( response );
							return;
						} else {
							console.error( "Error fetching blank user:" , xhr.statusText );
							resolve( false );
							return;
						}
					};
					xhr.onerror = function () {
						console.error( "GET request error" );
						resolve( false );
						return;
					};
					xhr.send();
				}
				catch( error ) { console.log( error ); resolve( false ); return; }
			});
		}
		function post_check_in( user ) {
			return new Promise( function( resolve , reject ) {
				try {
					var current_url = window.location.href;
					var url = current_url.replace( /\/new$/ , "/edit" );
					url = url.replace( /\/edit\/[0-9a-fA-F-]+$/ , "/edit" );
					var xhr = new XMLHttpRequest();
					xhr.open( "POST" , url , false );
					xhr.setRequestHeader( "Content-Type" , "application/json" );
					xhr.onload = function () {
						if ( xhr.status === 200 ) {
							console.log( "Successfully posted to:" , url );
							resolve( true );
							return;
						} else {
							console.error( "Error posting to:" , url , xhr.statusText );
							resolve( false );
							return;
						}
					};
					xhr.onerror = function () {
						console.error( "POST request error" );
						resolve( false );
						return;
					};
					var data = JSON.stringify( user );
					xhr.send( data );
				}
				catch( error ) { console.log( error ); resolve( false ); return; }
			});
		}
		function debounce_input( func , delay ) {
			let timer;
			return function( ...args ) {
				clearTimeout(timer);
				timer = setTimeout(() => func.apply(this, args), delay);
			};
		}
		function detect_input_type( typed_input ) {
			let valid_uuid = is_uuid( typed_input );
			if ( valid_uuid ) {
				return "uuid";
			}
			let valid_barcode = is_barcode( typed_input );
			if ( valid_barcode ) {
				return "barcode";
			}
			return "string"
			// let valid_ulid = is_ulid( typed_input );
			// let valid_proto_message = is_proto_message( typed_input );
		}
		function search_user( input_type , input ) {
			return new Promise( async function( resolve , reject ) {
				try {
					if ( input_type === "uuid" ) {
						console.log( "searching uuid" , input );
						let user = await get_user( input );
						resolve( [ user ] );
						return;
					}
					if ( input_type === "barcode" ) {
						let user = await get_user_by_barcode( input );
						resolve( [ user ] );
						return;
					}
					let potential_users = await fuzzy_search_user( input );
					resolve( potential_users );
					return;
				}
				catch( error ) { console.log( error ); resolve( false ); return; }
			});
		}
		( ()=> {
			window.USER = {};
			let barcode_input = document.getElementById( "barcode" );
			barcode_input.focus();

			const handle_input = debounce_input( async () => {
				let input = barcode_input.value.trim();
				let input_type = detect_input_type( input );
			    console.log( input_type , input );
				let users = await search_user( input_type , input );
				console.log( users );
			} , 300 );

			barcode_input.addEventListener( "input" , handle_input );


			// let checkin_form = document.getElementById( "user-checkin-form" );



			// document.getElementById( "username" ).value = user.user.username;
			// if ( user.user.family_members.length > 0 ) {
			// 	document.getElementById( "parents_first_name" ).value = user.user.family_members[ 0 ].first_name;
			// 	document.getElementById( "parents_last_name" ).value = user.user.family_members[ 0 ].last_name;
			// 	document.getElementById( "phone_number" ).value = user.user.family_members[ 0 ].phone_number;
			// 	document.getElementById( "email_address" ).value = user.user.family_members[ 0 ].email_address;
			// }
			// if ( user.user.barcodes.length > 0 ) {
			// 	document.getElementById( "barcode" ).value = user.user.barcodes[ 0 ];
			// }
			// document.getElementById( "family_size" ).value = user.user.family_size;
			// edit_form.addEventListener( "submit" , async function ( event ) {
			// 	event.preventDefault();
			// 	window.USER.BLANK.username = document.getElementById( "username" ).value.trim();
			// 	let parent = {
			// 		first_name: document.getElementById( "parents_first_name" ).value.trim() ,
			// 		last_name: document.getElementById( "parents_last_name" ).value.trim() ,
			// 		phone_number: document.getElementById( "phone_number" ).value.trim() ,
			// 		email_address: document.getElementById( "email_address" ).value.trim() ,
			// 	}
			// 	let barcode = document.getElementById( "barcode" ).value.trim();
			// 	if ( barcode.length > 0 ) {
			// 		window.USER.BLANK.barcodes = [];
			// 		window.USER.BLANK.barcodes.push( barcode );
			// 	}
			// 	window.USER.BLANK.family_members = [];
			// 	window.USER.BLANK.family_members.push( parent );
			// 	window.USER.BLANK.family_size = parseInt( document.getElementById( "family_size" ).value.trim() );
			// 	await _post( window.USER.BLANK );
			// 	alert( "user edited" );
			// });
		})();
	</script>
</body>
</html>