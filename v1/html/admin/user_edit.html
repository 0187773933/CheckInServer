<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Admin - Edit User</title>
	<script src="https://cdn.jsdelivr.net/npm/tweetnacl/nacl.min.js"></script>
</head>
<body>
	<!-- <h1>Create New User</h1> -->
<!-- 	<form id="new-user-form" action="/user/edit" method="post">
		<fieldset>
			<legend>User Information</legend>

			<label for="username">Username:</label>
			<input type="text" id="username" name="username" ><br><br>

			<label for="email">Email Address:</label>
			<input type="email" id="email" name="email_address" ><br><br>

			<label for="phone">Phone Number:</label>
			<input type="tel" id="phone" name="phone_number"><br><br>

			<label for="language">Preferred Language:</label>
			<input type="text" id="language" name="language"><br><br>

			<label for="family_size">Family Size:</label>
			<input type="number" id="family_size" name="family_size" value="1" min="1"><br><br>
		</fieldset>

		<fieldset>
			<legend>Personal Identity</legend>

			<label for="first_name">First Name:</label>
			<input type="text" id="first_name" name="identity[first_name]" required><br><br>

			<label for="last_name">Last Name:</label>
			<input type="text" id="last_name" name="identity[last_name]" required><br><br>

			<label for="middle_name">Middle Name:</label>
			<input type="text" id="middle_name" name="identity[middle_name]"><br><br>

			<label for="age">Age:</label>
			<input type="number" id="age" name="identity[age]" min="0"><br><br>

			<label for="sex">Sex:</label>
			<input type="text" id="sex" name="identity[sex]"><br><br>

			<label for="height">Height:</label>
			<input type="text" id="height" name="identity[height]"><br><br>

			<label for="eye_color">Eye Color:</label>
			<input type="text" id="eye_color" name="identity[eye_color]"><br><br>

			<label for="spouse">Spouse:</label>
			<input type="checkbox" id="spouse" name="identity[spouse]"><br><br>
		</fieldset>

		<fieldset>
			<legend>Address</legend>

			<label for="street_number">Street Number:</label>
			<input type="text" id="street_number" name="identity[address][street_number]"><br><br>

			<label for="street_name">Street Name:</label>
			<input type="text" id="street_name" name="identity[address][street_name]"><br><br>

			<label for="address_two">Address Line 2:</label>
			<input type="text" id="address_two" name="identity[address][address_two]"><br><br>

			<label for="city">City:</label>
			<input type="text" id="city" name="identity[address][city]"><br><br>

			<label for="state">State:</label>
			<input type="text" id="state" name="identity[address][state]"><br><br>

			<label for="zipcode">Zip Code:</label>
			<input type="text" id="zipcode" name="identity[address][zipcode]"><br><br>
		</fieldset>

		<fieldset>
			<legend>Date of Birth</legend>

			<label for="dob_month">Month:</label>
			<input type="text" id="dob_month" name="identity[date_of_birth][month]"><br><br>

			<label for="dob_day">Day:</label>
			<input type="number" id="dob_day" name="identity[date_of_birth][day]" min="1" max="31"><br><br>

			<label for="dob_year">Year:</label>
			<input type="number" id="dob_year" name="identity[date_of_birth][year]" min="1900"><br><br>
		</fieldset>

		<fieldset>
			<legend>Verification</legend>

			<label for="verified">Verified:</label>
			<input type="checkbox" id="verified" name="verified"><br><br>
		</fieldset>

		<button type="submit">Create User</button>
	</form> -->

	<h1>Create New User</h1>
	<form id="new-user-form" action="/user/edit" method="post">
		<fieldset>
			<legend>User Information</legend>

			<label for="username">Child's Name :</label>
			<input type="text" id="username" name="username" ><br><br>

			<label for="email">Parent's Name :</label>
			<input type="email" id="email" name="email_address" ><br><br>

			<label for="phone">Phone Number :</label>
			<input type="tel" id="phone" name="phone_number"><br><br>

			<label for="family_size">Family Size:</label>
			<input type="number" id="family_size" name="family_size" value="1" min="1"><br><br>
		</fieldset>
	</form>

	<script type="text/javascript">
		function convert_bytes_to_hex_string( key_bytes ) {
			let key_string = Array.from( key_bytes ).map( byte => byte.toString( 16 ).padStart( 2 , '0' ) ).join( '' );
			return key_string;
		}
		function uint8_array_to_base64( uint8Array ) {
			return btoa( String.fromCharCode( ...uint8Array ) );
		}
		function base64_to_uint8_array( base64 ) {
			return new Uint8Array( atob( base64 ).split( "" ).map( char => char.charCodeAt( 0 ) ) );
		}
		function get_blank_user() {
			return new Promise( function( resolve , reject ) {
				try {
					var currentUrl = window.location.href;
					var url = currentUrl.replace( /\/new$/ , "/blank" );
					var xhr = new XMLHttpRequest();
					xhr.open( "GET" , url , false );
					xhr.setRequestHeader( "Content-Type" , "application/json" );
					xhr.onload = function () {
						if ( xhr.status === 200 ) {
							var response = JSON.parse( xhr.responseText );
							resolve( response );
							return;
						} else {
							console.error( "Error fetching blank user:" , xhr.statusText );
							resolve( false );
							return;
						}
					};
					xhr.onerror = function () {
						console.error( "GET request error" );
						resolve( false );
						return;
					};
					xhr.send();
				}
				catch( error ) { console.log( error ); resolve( false ); return; }
			});
		}
		function post_new_user( blank_user ) {
			return new Promise( function( resolve , reject ) {
				try {
					var current_url = window.location.href;
					var url = current_url.replace( /\/new$/ , "/edit" );
					var xhr = new XMLHttpRequest();
					xhr.open( "POST" , url , false );
					xhr.setRequestHeader( "Content-Type" , "application/json" );
					xhr.onload = function () {
						if ( xhr.status === 200 ) {
							console.log( "Successfully posted to:" , url );
							resolve( true );
							return;
						} else {
							console.error( "Error posting to:" , url , xhr.statusText );
							resolve( false );
							return;
						}
					};
					xhr.onerror = function () {
						console.error( "POST request error" );
						resolve( false );
						return;
					};
					var data = JSON.stringify( blank_user );
					xhr.send( data );
				}
				catch( error ) { console.log( error ); resolve( false ); return; }
			});
		}
		function secret_box_encrypt( js_obj , key ) {
			try {
				let key_bytes = new Uint8Array( key );
				let key_nonce = new Uint8Array( 24 );
				window.crypto.getRandomValues( key_nonce );
				let json_string = JSON.stringify( js_obj );
				let js_bytes = new TextEncoder().encode( json_string );
				let sealed = nacl.secretbox( js_bytes , key_nonce , key_bytes );
				let combined = new Uint8Array( key_nonce.length + sealed.length );
				combined.set( key_nonce );
				combined.set( sealed , key_nonce.length );
				let result = uint8_array_to_base64( combined );
				return result;
			} catch( error ) { console.log( error ); return false; }
		}

		function secret_box_generate_new_key() {
			let key = nacl.randomBytes( 32 );
			return key;
		}

		async function derive_key(shared_secret) {
		    let hashBuffer = await crypto.subtle.digest("SHA-256", shared_secret);
		    return new Uint8Array(hashBuffer).slice(0, 32);
		}

		async function derive_key_hkdf(shared_secret) {
		    const salt = new Uint8Array(0); // Optional salt (can be left empty)
		    const info = new Uint8Array(0); // Optional info field

		    let keyMaterial = await crypto.subtle.importKey(
		        "raw", shared_secret, { name: "HKDF" }, false, ["deriveBits"]
		    );

		    let derivedBits = await crypto.subtle.deriveBits(
		        { name: "HKDF", hash: "SHA-256", salt, info },
		        keyMaterial, 256
		    );

		    return new Uint8Array(derivedBits);
		}

		( async ()=> {

			document.getElementById( "new-user-form" ).addEventListener( "submit" , function ( event ) {
				var current_url = window.location.href;
				var newAction = current_url.replace( /\/new$/ , "/edit" );
				this.action = newAction;
			});

			// 1.) Get Blank User Form
			let user = await get_blank_user();
			console.log( user );

			// Kyber Version
			// console.log( Kyber );
			// 2.) Generate Cypher-Text and Shared-Secret based on Server's Public Key
			// let recipient = new Kyber.MlKem1024();
			// const [ pkR , skR ] = await recipient.generateKeyPair();
			// const sender = new Kyber.MlKem1024();
			// const user_kp_uint8 = new Uint8Array( user.kp );
			// const [ ct , ssS ] = await sender.encap( user_kp_uint8 );

			// 3.) Encrypt User Data with Shared-Secret
			// const second_key = ssS.slice( 0 , 32 );
			// let user_encrypted = secret_box_encrypt( user.blank , second_key , user.ecb );
			// console.log( user_encrypted );

			// X25519 Version
			// 2.) Generate Cypher-Text and Shared-Secret based on Server's Public Key
			let server_pk = base64_to_uint8_array( user.pk );
			console.log( "server public key" );
			console.log( server_pk );
			let user_keypair = nacl.box.keyPair();
			// console.log( user_keypair );
			// let shared_secret = nacl.box.before( server_pk , user_keypair.secretKey );
			let shared_secret = nacl.scalarMult( user_keypair.secretKey , server_pk );
			console.log( "shared secret" );
			console.log( shared_secret );

			// Derive a key from the shared secret
			// let derived_key_old = nacl.hash( shared_secret ).slice( 0 , 32 );
			let derived_key = await derive_key_hkdf( shared_secret );
			// console.log( derived_key_old );
			console.log( "derived key" );
			console.log( derived_key );

			// 3.) Encrypt User Data with Shared-Secret
			let user_encrypted = secret_box_encrypt( user.blank , derived_key );
			// console.log( user_encrypted );

			// 4.) Post Encrypted User Data to Server
			let pk_b64 = uint8_array_to_base64( user_keypair.publicKey );
			console.log( user_keypair.publicKey );
			console.log( pk_b64 );

			post_new_user( { "w": user_encrypted , "pk": pk_b64 } );
			// console.log( user_encrypted );


		})();
	</script>
</body>
</html>
